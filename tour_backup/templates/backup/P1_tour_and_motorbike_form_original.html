<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/P1P2_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/print_styles.css') }}">
    <title>View Tour & Motorbike Bookings</title>
</head>
<body>
    <!-- Wrapper -->
    <div id="wrapper">
        <!-- Header -->
        <header id="header">
            <h1>
                <a href="{{ url_for('home') }}">Lamai Bayview Boutique Resort</a>
            </h1>
            <nav class="main">
                <ul>
                    <li class="menu">
                        <a class="fa-bars" href="#menu">Menu</a>
                    </li>
                </ul>
            </nav>
        </header>

        <!-- Menu -->
        <section id="menu">
            <!-- Links -->
            <section>
                <ul class="links">
                    <li>
                        <a href="tour_and_motorbike_form">
                            <h3 style="color: #000000;">Tour & Motorbike Rental</h3>
                            <p>click for view the form</p>
                        </a>
                    </li>
                    <li>
                        <a href="home_transfer_form">
                            <h3 style="color: #000000;">Home Transfer</h3>
                            <p>click for view the form</p>
                        </a>
                    </li>
                </ul>
            </section>

            <!-- Actions -->
            <section>
                <a href="{{ url_for('login') }}" 
                class="card-btn" 
                style="display: flex; justify-content: center; align-items: center; height: 40px;">
                Log out
                </a>
            </section>
        </section>
    </div>

    <div class="container">
        <div class="form-wrapper">
            <div class="gold-accent"></div>
            <div class="form-header">
                <h1>Lamai Bayview Boutique Resort</h1>
                <p>Tour & Motorbike Booking Management</p>
            </div>
            
            <div class="form-body">

                
                <!-- ฟอร์มค้นหา -->
                <form action="{{ url_for('search_bookings') }}" method="POST" class="search-form">
                    <h3 class="search-title">Search Bookings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="start_date">From Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ search_start_date if search_start_date else '' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="end_date">To Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ search_end_date if search_end_date else '' }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="room">Room</label>
                            <select class="form-control" id="room" name="room">
                                <option value="">All Rooms</option>
                                {% for room_number in room_list|default([]) %}
                                <option value="{{ room_number }}" {% if search_room == room_number %}selected{% endif %}>{{ room_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="experience_type">Experience Type</label>
                            <select class="form-control" id="experience_type" name="experience_type">
                                <option value="">All Types</option>
                                <option value="tour" {% if search_experience_type == 'tour' %}selected{% endif %}>Tour</option>
                                <option value="motorbike" {% if search_experience_type == 'motorbike' %}selected{% endif %}>Motorbike Rental</option>
                                <option value="all" {% if search_experience_type == 'all' %}selected{% endif %}>Both (Tour & Motorbike)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn">Search</button>
                </form>

                <form id="actionForm" method="POST">
                    <div class="table-container">
                        {% if bookings|default([])|length > 0 %}
                        <table class="booking-table">
                            <thead>
                                <tr>
                                    <th>SELECT</th>
                                    <th>Travel date</th>
                                    <th>Time</th>
                                    <th>Booking Date</th>
                                    <th>Booking No</th>
                                    <th>Name & Surname</th>
                                    <th>Room</th>
                                    <th>Company Name</th>
                                    <th>Detail</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Recieved</th>
                                    <th>Status</th>
                                    <th>Staff Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in bookings %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="selected_bookings" value="{{ booking.booking_no }}" style="width: 20px; height: 20px;">
                                    </td>
                                    <td>{{ booking.travel_date }}</td>
                                    <td>{{ booking.pickup_time }}</td>
                                    <td>{{ booking.booking_date }}</td>
                                    <td>{{ booking.booking_no }}</td>
                                    <td>{{ booking.customer_name }} {{ booking.customer_surname }}</td>
                                    <td>{{ booking.room }}</td>
                                    <td>{{ booking.company_name }}</td>
                                    <td>{{ booking.detail }}</td>
                                    <td>
                                        {% if booking.experience_type == 'tour' %}
                                        <span class="badge badge-tour">Tour</span>
                                        {% elif booking.experience_type == 'motorbike' %}
                                        <span class="badge badge-motorbike">Motorbike</span>
                                        {% elif booking.experience_type == 'all' %}
                                        <span class="badge badge-all">Both</span>
                                        {% else %}
                                        {{ booking.experience_type }}
                                        {% endif %}
                                    </td>
                                    <td>{{ booking.quantity }}</td>
                                    <td>{{ booking.received }}</td>
                                    <td class="{% if booking.payment_status == 'paid' %}status-paid{% elif booking.payment_status == 'unpaid' %}status-unpaid{% endif %}">
                                        {{ booking.payment_status|capitalize }}
                                    </td>
                                    <td>{{ booking.staff_name }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="empty-result">
                            <p>No bookings found. Please try different search criteria.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- แสดงข้อความแจ้งเตือน -->
                    <div id="alert-container" style="display: none;" class="alert"></div>

                    <div style="margin-top: 30px; text-align: center;">
                        <a class="card-btn" onclick="printSelection()">Print</a>
                        <a class="card-btn" id="cancelBtn" onclick="cancelBookings()">Cancel</a>
                        <a class="card-btn" id="editBtn" onclick="editBooking()">Edit</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับการแก้ไขข้อมูล -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Edit Booking</h2>
            </div>
            <form id="editForm" class="edit-form">
                <input type="hidden" id="edit_booking_no" name="booking_no">
                
                <div class="form-group">
                    <label for="edit_date">Travel Date:</label>
                    <input type="date" id="edit_date" name="date" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_time">Pickup Time:</label>
                    <input type="time" id="edit_time" name="time" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_name">First Name:</label>
                    <input type="text" id="edit_name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_surname">Last Name:</label>
                    <input type="text" id="edit_surname" name="surname" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_room">Room:</label>
                    <select id="edit_room" name="room" required>
                        {% for room_number in room_list|default([]) %}
                        <option value="{{ room_number }}">{{ room_number }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit_experienceType">Experience Type:</label>
                    <select id="edit_experienceType" name="experienceType" required>
                        <option value="tour">Tour</option>
                        <option value="motorbike">Motorbike Rental</option>
                        <option value="all">Both (Tour & Motorbike)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit_company">Company Name:</label>
                    <input type="text" id="edit_company" name="company">
                </div>
                
                <div class="form-group">
                    <label for="edit_detail">Detail:</label>
                    <textarea id="edit_detail" name="detail" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="edit_persons">Quantity:</label>
                    <input type="number" id="edit_persons" name="persons" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_price">Price Received:</label>
                    <input type="number" id="edit_price" name="price" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_status">Payment Status:</label>
                    <select id="edit_status" name="status" required>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit_staffName">Staff Name:</label>
                    <input type="text" id="edit_staffName" name="staffName" required>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn" onclick="saveBooking()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='assets/js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/browser.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/breakpoints.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/util.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/main.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Date validation - ensure "to" date is after "from" date
            const startDate = document.getElementById('start_date');
            const endDate = document.getElementById('end_date');
            
            startDate.addEventListener('change', function() {
                if (startDate.value) {
                    endDate.min = startDate.value;
                    if (endDate.value && endDate.value < startDate.value) {
                        endDate.value = startDate.value;
                    }
                } else {
                    endDate.min = "";
                }
            });
        });
        
        // แสดงข้อความแจ้งเตือน
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.className = 'alert alert-' + type;
            alertContainer.textContent = message;
            alertContainer.style.display = 'block';
            
            // ให้ข้อความแจ้งเตือนหายไปหลังจาก 5 วินาที
            setTimeout(function() {
                alertContainer.style.display = 'none';
            }, 5000);
        }
        
        // ฟังก์ชันสำหรับการยกเลิกการจอง (ลบข้อมูล)
        function cancelBookings() {
            const selectedBookings = document.querySelectorAll('input[name="selected_bookings"]:checked');
            
            if (selectedBookings.length === 0) {
                showAlert('Please select at least one booking to cancel.', 'info');
                return;
            }
            
            if (confirm('Are you sure you want to cancel the selected bookings?')) {
                const form = document.getElementById('actionForm');
                form.action = "{{ url_for('cancel_bookings') }}";
                
                // ใช้ AJAX ส่งข้อมูล
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                        // รีโหลดหน้าเพื่อแสดงข้อมูลล่าสุด
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('An error occurred. Please try again.', 'danger');
                    console.error('Error:', error);
                });
            }
        }
        
        // ฟังก์ชันสำหรับการเปิด Modal แก้ไขข้อมูล
        function editBooking() {
            const selectedBookings = document.querySelectorAll('input[name="selected_bookings"]:checked');
            
            if (selectedBookings.length === 0) {
                showAlert('Please select a booking to edit.', 'info');
                return;
            }
            
            if (selectedBookings.length > 1) {
                showAlert('Please select only one booking to edit.', 'info');
                return;
            }
            
            const bookingNo = selectedBookings[0].value;
            
            // สร้าง FormData สำหรับส่งข้อมูล
            const formData = new FormData();
            formData.append('booking_no', bookingNo);
            
            // ดึงข้อมูลการจองจาก server
            fetch("{{ url_for('get_booking_details') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // เติมข้อมูลลงในฟอร์มแก้ไข
                    const booking = data.booking;
                    document.getElementById('edit_booking_no').value = booking.booking_no;
                    document.getElementById('edit_date').value = booking.travel_date;
                    document.getElementById('edit_time').value = booking.pickup_time;
                    document.getElementById('edit_name').value = booking.customer_name;
                    document.getElementById('edit_surname').value = booking.customer_surname;
                    document.getElementById('edit_room').value = booking.room;
                    document.getElementById('edit_experienceType').value = booking.experience_type;
                    document.getElementById('edit_company').value = booking.company_name;
                    document.getElementById('edit_detail').value = booking.detail;
                    document.getElementById('edit_persons').value = booking.quantity;
                    document.getElementById('edit_price').value = booking.received;
                    document.getElementById('edit_status').value = booking.payment_status;
                    document.getElementById('edit_staffName').value = booking.staff_name;
                    
                    // แสดง Modal
                    document.getElementById('editModal').style.display = 'block';
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('An error occurred while fetching booking details.', 'danger');
                console.error('Error:', error);
            });
        }
        
        // ฟังก์ชันปิด Modal
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // ฟังก์ชันบันทึกการแก้ไขข้อมูล
        function saveBooking() {
            const form = document.getElementById('editForm');
            const formData = new FormData(form);
            
            fetch("{{ url_for('update_booking') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    showAlert(data.message, 'success');
                    // รีโหลดหน้าเพื่อแสดงข้อมูลล่าสุด
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('An error occurred while saving booking data.', 'danger');
                console.error('Error:', error);
            });
        }
        
        // ฟังก์ชันสำหรับการพิมพ์
        function printSelection() {
            window.print();
        }
        
        // เมื่อคลิกที่พื้นที่นอก Modal ให้ปิด Modal
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>